@let loading = isLoading();
@let showIcons = isShowIcons();
@let preview = previewImage();
@let title = formTitle();
@let fields = formFields();
@let isShowLabel = showLabel();
@let icons = iconList;
@let selectedIcon = selectedIconIndex();

<form [formGroup]="form" (ngSubmit)="onSubmit()">
    @if(title){
    <h2>{{ title }}</h2>
    }

    @for(field of fields; track field.name) {
    @if(field.isShow){
    <div class="form-input">
        @let error = getError(field.name!);

        @if(error){
        <small>(*) {{ error }}</small>
        }
        @else if(field.name === 'confirmPassword' && form.errors?.['passwordMismatch']){
        <small>(*) {{ errorMessage.PASSWORD_MISMATCH }}</small>
        }

        @if(isShowLabel && field.isShow){
        <label class="form-label" [for]="field.name">
            {{field.label}}
        </label>
        }

        <div>
            @if(field.type === 'textarea'){
            <textarea [id]="field.name" [formControlName]="field.name!" [placeholder]="field.label"></textarea>
            }
            @else if(field.type === 'select'){
            <select [id]="field.name" [formControlName]="field.name!">
                @for(category of field.categories; track category.id) {
                <option [value]="category.id">{{ category.name }}</option>
                }
            </select>
            }
            @else if(field.type === 'image'){
            <div class="image-upload">
                <input id="imageFile" type="file" accept="image/*" (change)="onFileSelected($event)"
                    style="display: none;" #fileInput />

                @let imageUrl = field.defaultValue;

                @if((!imageUrl || imageUrl === '') && !loading){
                <div class="camera-box" (click)="fileInput.click()">
                    <i class="fa-solid fa-camera"></i>
                </div>
                }

                @if(loading){
                <div class="image-preview" style="position: relative; display: inline-block;">
                    <img [src]="preview" alt="Preview Image" width="200" height="150" />
                    <div class="spinner-overlay">
                        <div class="spinner"></div>
                    </div>
                </div>
                }

                @if(!loading && imageUrl){
                <div class="image-preview">
                    <img [src]="field.defaultValue" alt="Preview Image" width="200" height="150" />
                    <div class="product-edit-btn" (click)="fileInput.click()">
                        <button type="button"><i class="pi pi-pencil"></i></button>
                    </div>
                </div>
                }
            </div>
            }
            @else{
            <input [type]="field.type" [id]="field.name" [formControlName]="field.name!" [placeholder]="field.label"
                #formInput>
            }

            @if(field.type !== 'image' && field.name !== 'id'){
            <label [for]="field.name" (click)="showPassword(field)">
                <i [class]="field.icon"></i>
            </label>
            }
        </div>

        @if(showIcons){
        <div class="icon-container">
            <p>Icon List</p>
            <div class="icon-list">
                @for(icon of icons; let index = $index; track icon){
                <div class="icon-item" [title]="getTitleIcon(icon)"
                    [class.active]="index === selectedIcon" (click)="selectIcon(index)">
                    <i [class]="`fa-solid fa-${icon}`"></i>
                </div>
                }
            </div>
        </div>
        }
    </div>
    }
    }

    @if(buttonLabel(); as buttonLabel){
    <button type="submit" class="btn-submit" [ngClass]="{'no-active' : form.invalid || loading}">
        {{ buttonLabel }}
    </button>
    }

    @if(formLinkMessage(); as formLinkMessage){
    <div class="link-container">
        <p><i>{{ formLinkMessage }}</i></p>
        <a [routerLink]="[formUrl()]">
            {{ formLinkTitle() }}
        </a>
    </div>
    }
</form>